apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
  name: openbao--pre-release
spec:
  interval: 10m
  releaseName: openbao--pre-release
  chart:
    spec:
      chart: ./tools/charts/generic
      sourceRef:
        kind: GitRepository
        name: flux-system
        namespace: flux-system
  install:
    createNamespace: false
    remediation:
      retries: -1
      remediateLastFailure: true
  upgrade:
    remediation:
      retries: -1
      remediateLastFailure: true
  values:
    resources:
      externalsecret-postgres-storage:
        apiVersion: external-secrets.io/v1
        kind: ExternalSecret
        metadata:
          name: openbao-postgres-storage
        spec:
          refreshInterval: 5m
          secretStoreRef:
            name: kubernetes-local-all
            kind: ClusterSecretStore
          target:
            name: openbao-postgres-storage
            creationPolicy: Owner
            template:
              type: Opaque
              engineVersion: v2
              data:
                config.hcl: |-
                  storage "postgresql" {
                    connection_url = "postgres://openbao:{{ .openbao }}@openbao-postgresql.openbao.svc.cluster.local:5432/openbao?sslmode=require"
                  }
          data:
            - secretKey: openbao
              remoteRef:
                key: openbao.openbao-postgresql.credentials.postgresql.acid.zalan.do
                property: password
      issuer-openbao-selfsigned:
        apiVersion: cert-manager.io/v1
        kind: Issuer
        metadata:
          name: openbao-selfsigned
        spec:
          selfSigned: {}
      certificate-openbao-tls:
        apiVersion: cert-manager.io/v1
        kind: Certificate
        metadata:
          name: openbao-tls
        spec:
          secretName: openbao-tls
          dnsNames:
            - openbao.openbao.svc
            - openbao.openbao.svc.cluster.local
          issuerRef:
            name: openbao-selfsigned
            kind: Issuer
      injector-selfsigned-ca:
        apiVersion: cert-manager.io/v1
        kind: Certificate
        metadata:
          name: injector-selfsigned-ca
        spec:
          isCA: true
          commonName: Agent Inject CA
          secretName: injector-ca-secret
          duration: 87660h  # 10 years
          privateKey:
            algorithm: ECDSA
            size: 256
          issuerRef:
            name: openbao-selfsigned
            kind: Issuer
            group: cert-manager.io
      injector-ca-issuer:
        apiVersion: cert-manager.io/v1
        kind: Issuer
        metadata:
          name: injector-ca-issuer
        spec:
          ca:
            secretName: injector-ca-secret
      injector-certificate:
        apiVersion: cert-manager.io/v1
        kind: Certificate
        metadata:
          name: injector-certificate
        spec:
          secretName: injector-tls
          duration: 24h
          renewBefore: 144m  # roughly 10% of 24h
          dnsNames:
          - openbao-agent-injector-svc
          - openbao-agent-injector-svc.openbao
          - openbao-agent-injector-svc.openbao.svc
          issuerRef:
            name: injector-ca-issuer
          commonName: Agent Inject Cert
