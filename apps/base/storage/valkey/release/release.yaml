apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
  name: valkey
spec:
  chartRef:
    kind: OCIRepository
    name: bitnami-oci
  install:
    createNamespace: false
    remediation:
      retries: -1
      remediateLastFailure: true
  upgrade:
    remediation:
      retries: -1
      remediateLastFailure: true
  interval: 1m0s
  releaseName: valkey
  values:
    global:
      storageClass: "default"
      security:
        allowInsecureImages: true
    architecture: "replication"

    auth:
      enabled: true

    tls:
      enabled: true
      authClients: true
      autoGenerated: false
      existingSecret: "valkey-tls-secret"
      certFilename: "tls.crt"
      certKeyFilename: "tls.key"
      certCAFilename: "ca.crt"

    image:
      registry: docker.io
      repository: bitnamilegacy/valkey
      tag: 8.1.3-debian-12-r3

    primary:
      replicaCount: 1
      podLabels:
        'app.sap.io/component': "master"
        'app.sap.io/name': "valkey-cluster"
      persistence:
        enabled: true
        size: 8Gi
      resources:
        requests:
          memory: "512Mi"
          cpu: "500m"
        limits:
          memory: "2Gi"
          cpu: "2000m"
      nodeSelector: { }
      tolerations: [ ]
      affinity:
        podAntiAffinity:
          preferredDuringSchedulingIgnoredDuringExecution:
            - weight: 100
              podAffinityTerm:
                labelSelector:
                  matchExpressions:
                    - key: app.sap.io/component
                      operator: In
                      values:
                        - master
                topologyKey: "kubernetes.io/hostname"


    replica:
      replicaCount: 1
      podLabels:
        'app.sap.io/component': "replica"
      persistence:
        enabled: true
        size: 15Gi
      resources:
        requests:
          memory: "512Mi"
          cpu: "500m"
        limits:
          memory: "2Gi"
          cpu: "2000m"
      nodeSelector: { }
      tolerations: [ ]
      affinity:
        podAntiAffinity:
          requiredDuringSchedulingIgnoredDuringExecution:
            # Ensure Redis Masters are on different nodes
            - labelSelector:
                matchExpressions:
                  - key: app.sap.io/component
                    operator: In
                    values:
                      - master
              topologyKey: "kubernetes.io/hostname"

            # Ensure Redis Replicas do not schedule on the same node as another Replica
            - labelSelector:
                matchExpressions:
                  - key: app.sap.io/component
                    operator: In
                    values:
                      - replica
              topologyKey: "kubernetes.io/hostname"

            # Ensure Redis Replicas do not schedule on the same node as their Master
            - labelSelector:
                matchExpressions:
                  - key: app.sap.io/name
                    operator: In
                    values:
                      - valkey-cluster
              topologyKey: "kubernetes.io/hostname"

    sysctl:
      net.core.somaxconn: 10000

    securityContext:
      enabled: true
      fsGroup: 1001
      runAsUser: 1001

    networkPolicy:
      enabled: true
      ingressNSMatchLabels:
        valkey: external
      ingressNSPodMatchLabels:
        valkey-client: true

    sentinel:
      enabled: false
      quorum: 2

    metrics:
      enabled: false  # Enable Prometheus metrics
      serviceMonitor:
        enabled: false
