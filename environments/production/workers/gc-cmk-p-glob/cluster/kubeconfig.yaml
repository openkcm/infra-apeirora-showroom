---
apiVersion: external-secrets.io/v1
kind: ExternalSecret
metadata:
  name: template
spec:
  secretStoreRef:
    name: vault-backend-cluster
    kind: ClusterSecretStore
  target:
    name: kubeconfig
    template:
      type: Opaque
      engineVersion: v2
      data:
        value.yaml: |
          ---
          apiVersion: v1
          kind: Config
          current-context: gc-cmk-p-glob
          clusters:
            - cluster:
                certificate-authority-data: "{{ .ca }}"
                server: https://api.gc-cmk-p-glob.cmkc.kms.cloud.sap
              name: gc-cmk-p-glob
          contexts:
            - context:
                cluster: gc-cmk-p-glob
                namespace: default
                user: default
              name: gc-cmk-p-glob
          users:
            - name: default
              user:
                exec:
                  apiVersion: "client.authentication.k8s.io/v1"
                  interactiveMode: Never
                  command: "sh"
                  args:
                    - "-c"
                    - |
                      #set -e -o pipefail
                      # return token back to the credential plugin
                      cat << EOF
                      {
                      "apiVersion": "client.authentication.k8s.io/v1",
                      "kind": "ExecCredential",
                      "status": {
                          "token": "$(cat /var/run/secrets/tokens/federated-token)"
                      }
                      }
                      EOF
  data:
  - secretKey: ca
    remoteRef:
      key: certificates/kubeconfigs
      property: ca_gc-cmk-p-glob
